rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'librarian', 'vice_president', 'supplement'];
    }
    
    // --- SECURE CONFIGURATION ---
    match /config/{docId} {
      // Required for regular users to retrieve shared tokens for departmental uploads
      allow read: if isAuthenticated();
      allow write: if isAdmin(); 
    }

    // --- USERS COLLECTION ---
    match /users/{userId} {
      allow read: if true;
      allow create: if isOwner(userId) && request.resource.data.role == 'student';
      allow update: if (isOwner(userId) && request.writeFields.hasOnly(['name', 'level', 'matricNumber', 'avatarUrl', 'username', 'savedQuestions', 'lastActive', 'badges', 'viewedSessionWrapTimestamp', 'aiCredits', 'lastCreditRefreshDate'])) || isAdmin();
      allow delete: if isAdmin();
    }

    // --- NOTIFICATIONS ---
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || resource.data.userId == 'all');
      allow create: if isAdmin();
      allow update: if isAuthenticated() && (isOwner(resource.data.userId) || isAdmin());
      allow delete: if isAuthenticated() && (isOwner(resource.data.userId) || isAdmin());
    }

    // --- PAST QUESTIONS (ARCHIVES) ---
    match /questions/{questionId} {
      allow read: if resource.data.status == 'approved' || isAdmin() || (isAuthenticated() && resource.data.uploadedBy == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // --- COMMUNITY CHAT ---
    match /community_messages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid;
      allow delete: if isAdmin() || (isAuthenticated() && request.resource.data.senderId == request.auth.uid);
    }

    // --- TEST RESULTS (History) ---
    match /test_results/{resultId} {
      allow read: if true; 
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    // --- LEADERBOARD (Best Scores) ---
    match /leaderboard/{userId} {
      allow read: if true;
      allow write: if isOwner(userId) || isAdmin();
    }
    
    // --- PRIVATE NOTES ---
    match /notes/{noteId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if (isAuthenticated() && request.resource.data.userId == request.auth.uid) || isAdmin();
    }

    // --- SYSTEM STATS ---
    match /system_stats/{docId} {
      allow read: if isAdmin();
      allow write: if docId == 'ai_usage' && isAuthenticated();
    }

    // --- LOST & FOUND ---
    match /lost_items/{itemId} {
      allow read: if resource.data.status == 'approved' || resource.data.status == 'recovered' || isAdmin();
      allow create: if isAuthenticated() && request.resource.data.status == 'approved';
      allow update: if (isAuthenticated() && resource.data.finderId == request.auth.uid && request.resource.data.status == 'recovered') || isAdmin();
      allow delete: if isAdmin();
    }
    
    // --- MARKETPLACE ---
    match /marketplace/{itemId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.sellerId == request.auth.uid;
        allow update, delete: if (isAuthenticated() && resource.data.sellerId == request.auth.uid) || isAdmin();
    }

    // --- PUBLIC CONTENT (Managed by Admin) ---
    match /content/{docId} {
      allow read: if true;
      allow write: if isAdmin() || docId == 'impression_poll';
    }
    match /announcements/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /gallery/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /executives/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /lecturers/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /groups/{docId} { allow read: if true; allow write: if isAdmin(); }
  }
}