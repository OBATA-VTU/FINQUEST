rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    
    // Check if user is logged in
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if the user accessing the data is the owner of the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Check if the user has the 'admin' role in their user profile
    // Note: This costs one extra read operation per request.
    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- USERS COLLECTION ---
    match /users/{userId} {
      // Anyone can read profiles (needed for Chat avatars, Leaderboard, etc.)
      allow read: if true;
      
      // Creation: Allow if auth UID matches and role is strictly 'student' (prevent self-promotion on signup)
      allow create: if isOwner(userId) && request.resource.data.role == 'student';
      
      // Update: 
      // 1. Owner can update a limited set of their profile fields.
      // 2. Admin can update anything.
      allow update: if (isOwner(userId) && request.writeFields.hasOnly(['name', 'level', 'matricNumber', 'avatarUrl', 'username', 'savedQuestions', 'lastActive'])) || isAdmin();
      
      // Delete: Only admins can delete users
      allow delete: if isAdmin();
    }

    // --- NOTIFICATIONS ---
    match /notifications/{notificationId} {
      // Read: Users can see notifications meant for them OR broadcast to 'all'
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || resource.data.userId == 'all');
      
      // Create: Only Admins can send notifications (via Admin Panel)
      allow create: if isAdmin();
      
      // Delete: Users can dismiss (delete) their own notifications. Admins can delete any.
      allow delete: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // --- PAST QUESTIONS (ARCHIVES) ---
    match /questions/{questionId} {
      // Read: Public can see 'approved' questions. Admins/Owners see all (including pending).
      allow read: if resource.data.status == 'approved' || isAdmin() || (isAuthenticated() && resource.data.uploadedBy == request.auth.uid);
      
      // Create: Authenticated students can upload (status should be 'pending' by default logic)
      allow create: if isAuthenticated();
      
      // Update: Only Admin can approve/edit questions.
      allow update: if isAdmin();
      
      // Delete: Only Admin can delete questions.
      allow delete: if isAdmin();
    }

    // --- COMMUNITY CHAT ---
    match /community_messages/{messageId} {
      allow read: if isAuthenticated();
      // Create: Auth users can send messages, must be marked as sender
      allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid;
      // Delete: Only Admins (for moderation)
      allow delete: if isAdmin();
    }

    // --- TEST RESULTS (History) ---
    match /test_results/{resultId} {
      allow read: if true; // Public stats
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Results should be immutable usually, but Admin can delete bad data
      allow update, delete: if isAdmin();
    }

    // --- LEADERBOARD (Best Scores) ---
    match /leaderboard/{userId} {
      allow read: if true;
      // Users can update their score, Admins can manage records.
      allow write: if isOwner(userId) || isAdmin();
    }
    
    // --- PRIVATE NOTES (New) ---
    match /notes/{noteId} {
      // Admins need full access for moderation/wipe, owners have full control of their own.
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if (isAuthenticated() && resource.data.userId == request.auth.uid) || isAdmin();
    }

    // --- SYSTEM STATS (New - For Admin Health) ---
    match /system_stats/{docId} {
      allow read: if isAdmin();
      // Allow authenticated users to increment usage counters (e.g. for AI calls)
      allow update: if isAuthenticated(); 
      allow create: if isAdmin();
    }

    // --- LOST & FOUND ---
    match /lost_items/{itemId} {
      // Read: Public sees Approved/Recovered. Owner sees their own pending. Admin sees all.
      allow read: if resource.data.status == 'approved' || 
                     resource.data.status == 'recovered' || 
                     (isAuthenticated() && (resource.data.finderId == request.auth.uid || isAdmin()));
      
      // Create: Any logged in user can report a lost item
      allow create: if isAuthenticated();
      
      // Update: 
      // 1. Owner can mark status as 'recovered'.
      // 2. Admin can approve ('approved') or edit.
      allow update: if (isAuthenticated() && resource.data.finderId == request.auth.uid && request.resource.data.status == 'recovered') || isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // --- PUBLIC CONTENT (Managed by Admin) ---
    // Includes: Announcements, Gallery, Executives, Lecturers, Site Settings
    match /announcements/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /gallery/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /executives/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /lecturers/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /content/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /groups/{docId} { allow read: if true; allow write: if isAdmin(); }
  }
}